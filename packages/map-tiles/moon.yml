id: map-tiles
language: typescript
platform: node
type: library

tasks:
  download_pbf:
    command: curl
    args:
      - -L
      - -o
      - ./dist/planet.osm.pbf
      - https://download.geofabrik.de/europe/united-kingdom/scotland-latest.osm.pbf
    outputs:
      - ./dist/planet.osm.pbf
    options:
      cache: true
      persistent: false
      outputStyle: stream

  download_terrain:
    command: curl
    args:
      - -L
      - -o
      - ./dist/terrain_tmp/terrain.zip
      - https://www.eorc.jaxa.jp/ALOS/aw3d30/data/release_v2404/N050W005_N055E000.zip
    outputs:
      - ./dist/terrain_tmp/terrain.zip
    options:
      cache: true
      persistent: false
      outputStyle: stream

  extract_terrain:
    deps:
      - download_terrain
    command: unzip
    args:
      - -d
      - ./dist/terrain_tmp
      - ./dist/terrain_tmp/terrain.zip
    inputs:
      - ./dist/terrain_tmp/terrain.zip
    outputs:
      - ./dist/terrain_tmp/N050W005_N055E000
    options:
      cache: true
      persistent: false
      outputStyle: stream

  build_terrain:
    command: src/terrain/build.sh
    inputs:
      - ./src/terrain/input
    outputs:
      - ./dist/terrain
    options:
      cache: true
      persistent: false
      outputStyle: stream

  build_vector:
    deps:
      - download_pbf
    command: sh
    args:
      - -c
      - |
        mkdir -p dist/store && bin/tilemaker-ubuntu-22.04/tilemaker ./dist/planet.osm.pbf \
          --output ./dist/vector \
          --config ./src/vector/config.json \
          --store ./dist/store \
          --process src/vector/process-openmaptiles.lua \
          --materialize-geometries; rm -rf ./dist/store
    inputs:
      - ./src/vector
      - ./dist/planet.osm.pbf
    outputs:
      - ./dist/vector
    options:
      cache: true
      persistent: false
      outputStyle: stream

  up:
    command: nodemon
    args:
      - -w
      - src
      - -w
      - Dockerfile
      - --exec
      - moon map-tiles:build_vector map-tiles:build_terrain
    options:
      cache: false
      persistent: true
