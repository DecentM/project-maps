id: map-tiles
language: typescript
platform: node
type: library

tasks:
  clean_vector:
    command: rm
    args:
      - -rf
      - ./dist/vector
    options:
      cache: false
      persistent: false
      outputStyle: stream
      envFile: /.env

  build_vector:
    deps:
      - clean_vector
    command: bin/build_planetiles.sh
    args:
      - $TILES_DOWNLOAD_URL
      - https://osmdata.openstreetmap.de/download/simplified-water-polygons-split-3857.zip
      - https://shortbread.geofabrik.de/shapefiles/admin-points-4326.zip
      - ./dist/vector
      - /usr/local/bin/planetiler.jar
    inputs:
      - ./bin/build_planetiles.sh
      - ./src/vector
    outputs:
      - ./dist/vector
    options:
      cache: true
      persistent: false
      outputStyle: stream
      envFile: /.env

  build_tints:
    command: sh
    args:
      - -c
      - rm -rf ./dist/tints && bin/build_tiles.sh $TINTS_DOWNLOAD_URL ./dist/tints png
    inputs:
      - ./bin/build_tiles.sh
    outputs:
      - ./dist/tints
    options:
      cache: true
      persistent: false
      outputStyle: stream
      envFile: /.env

  up:
    command: nodemon
    args:
      - -w
      - src
      - -w
      - Dockerfile
      - --exec
      - moon map-tiles:build_tints
    options:
      cache: false
      persistent: true
