id: map-tiles
language: typescript
platform: node
type: library

tasks:
  build:
    env:
      DOCKER_BUILDKIT: "1"
    command: sh
    args:
      - -c
      - docker build --build-arg=PBF_URL=http://download.geofabrik.de/europe/united-kingdom-latest.osm.pbf -t map-tiles:latest . && docker create map-tiles:latest > ./.ignored/map-tiles-container-id && docker cp $(cat ./.ignored/map-tiles-container-id):/app/dist ./ && docker rm -f $(cat ./.ignored/map-tiles-container-id) && rm -f ./.ignored/map-tiles-container-id && docker rmi -f map-tiles:latest
    inputs:
      - ./src
      - ./Dockerfile
    outputs:
      - ./dist
    options:
      cache: true
      persistent: false

  up:
    command: nodemon
    args:
      - -w
      - src
      - -w
      - Dockerfile
      - --exec
      - moon map-tiles:build
    options:
      cache: false
      persistent: true
