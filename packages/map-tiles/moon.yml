id: map-tiles
language: typescript
platform: node
type: library

tasks:
  build_docker:
    env:
      DOCKER_BUILDKIT: "1"
    command: sh
    args:
      - -c
      - docker build --build-arg=PBF_URL=https://download.geofabrik.de/europe/united-kingdom/england/greater-london-latest.osm.pbf -t map-tiles:latest .
    options:
      # docker caches by itself
      cache: false

  extract_docker:
    deps:
      - build_docker
    command: sh
    args:
      - -c
      - docker create map-tiles:latest > /tmp/map-tiles-container-id
    options:
      cache: false

  copy_docker:
    deps:
      - extract_docker
    command: sh
    args:
      - -c
      - docker cp $(cat /tmp/map-tiles-container-id):/app/dist ./
    options:
      cache: false

  cleanup_docker:
    deps:
      - copy_docker
    command: sh
    args:
      - -c
      - docker rm $(cat /tmp/map-tiles-container-id) && rm /tmp/map-tiles-container-id
    options:
      cache: false

  build:
    deps:
      - build_docker
      - extract_docker
      - copy_docker
      - cleanup_docker
    options:
      cache: false

  dev:
    command: nodemon
    args:
      - -w
      - src
      - -w
      - Dockerfile
      - --exec
      - moon map-tiles:build
    options:
      cache: false
