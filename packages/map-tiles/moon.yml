id: map-tiles
language: typescript
platform: node
type: library

tasks:
  download_pbf:
    command: curl
    args:
      - -L
      - -o
      - ./dist/planet.osm.pbf
      - http://download.geofabrik.de/europe/united-kingdom/england/derbyshire-latest.osm.pbf
    outputs:
      - ./dist/planet.osm.pbf
    options:
      cache: true
      persistent: false
      outputStyle: stream

  build:
    deps:
      - download_pbf
    command: sh
    args:
      - -c
      - |
        mkdir -p dist/store && bin/tilemaker-ubuntu-22.04/tilemaker ./dist/planet.osm.pbf \
          --output ./dist/ \
          --config ./src/config.json \
          --store ./dist/store \
          --process src/process-openmaptiles.lua \
          --materialize-geometries; rm -rf ./dist/store
    inputs:
      - ./src
      - ./dist/planet.osm.pbf
    outputs:
      - ./dist
    options:
      cache: true
      persistent: false
      outputStyle: stream

  up:
    command: nodemon
    args:
      - -w
      - src
      - -w
      - Dockerfile
      - --exec
      - moon map-tiles:build
    options:
      cache: false
      persistent: true
