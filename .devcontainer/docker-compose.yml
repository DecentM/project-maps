services:
  devcontainer:
    image: ghcr.io/decentm/project-maps-devcontainer:latest
    network_mode: host
    volumes:
      - ..:/workspace
      - ${HOME}/.ssh:/home/user/.ssh:ro
      - ${HOME}/.gitconfig:/home/user/.gitconfig:ro
      - ${HOME}/.npmrc:/home/user/.npmrc:ro
      - ${HOME}/.gnupg:/home/user/.gnupg
      - ${HOME}/.bashrc:/home/user/.bashrc_user:ro
    env_file:
      - ../.env
    command: sleep infinity
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 7g

  envoy:
    image: envoyproxy/envoy:v1.33-latest
    network_mode: host
    volumes:
      - ./envoy.yaml:/etc/envoy/envoy.yaml:ro
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 128m

  nginx:
    image: nginx:1.29.0-alpine
    network_mode: host
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ../packages/map-tiles/dist:/usr/share/nginx/html/tile:ro
      - ../packages/map-style/dist/sprites:/usr/share/nginx/html/sprites:ro
      - ../packages/map-fonts/dist:/usr/share/nginx/html/fonts:ro
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 128m

  nominatim:
    image: mediagis/nominatim:5.1
    ports:
      - 9099:8080
    environment:
      PBF_URL: https://download.geofabrik.de/europe/united-kingdom/england/greater-london-latest.osm.pbf
      PROJECT_DIR: /nominatim
    volumes:
      - nominatim_data:/var/lib/postgresql
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4g

  overpass:
    image: wiktorn/overpass-api
    ports:
      - 9098:80
    environment:
      OVERPASS_META: 'yes'
      OVERPASS_MODE: 'init'
      OVERPASS_PLANET_URL: https://download.geofabrik.de/europe/united-kingdom/england/greater-london-latest.osm.bz2
      OVERPASS_RULES_LOAD: '50'
      OVERPASS_STOP_AFTER_INIT: 'false'
      OVERPASS_ALLOW_DUPLICATE_QUERIES: 'yes'
    volumes:
      - overpass_data:/db
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4g

volumes:
  overpass_data:
  nominatim_data:
